name: Python Workflow
on: [push]

permissions:
  id-token: write
  contents: read

jobs:
  lint:
    uses: PedroHPAlmeida/actions-workflows-python/.github/workflows/flake8.yaml@1.2
    with:
      python-version: '3.10' 
      
  test:
    needs: lint
    uses: PedroHPAlmeida/actions-workflows-python/.github/workflows/pytest.yaml@1.2
    with:
      python-version: '3.10' 

  publish:
    needs: test
    uses: PedroHPAlmeida/actions-workflows-ecr/.github/workflows/publish-ecr.yaml@1.3
    with:
      image_name: binance-trades-bot
      image_tag: ${{ github.sha }}
      aws_region: ${{ vars.AWS_REGION }}
    secrets:
      aws_role_to_assume: ${{ secrets.AWS_ROLE }}

  deploy-infra:
    needs: publish
    uses: PedroHPAlmeida/actions-workflows-terraform/.github/workflows/terraform.yaml@1.3
    with:
      terraform_version: '1.7.5'
      working-directory: ./infra
    secrets:
      tf_api_token: ${{ secrets.TF_API_TOKEN }}
